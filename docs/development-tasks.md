# SOFU AR Character Creator – Development Task List

- [x] Project setup: repository structure, lint/test tooling, env handling, i18n scaffolding.
- [x] Design system components: Header, Instruction banner, Divider, Message block, Inputs, Tile grid, Card, Progress bar per `docs/design-spec.md`.
- [x] Step 0 flow: device detection, language toggle, terms consent, session ID generation, permissions notice, moderation pre-checks.
- [x] Stage flow (Step A): text entry with moderation, upload pipeline (camera/library permissions, EXIF strip, resize/WebP, cleanup), Nanobanana stage generation, selection UI.
  - Oct 07 2025: Updated early-step flow — Step3 now hosts the map search with compact placeholder guidance, Step4 becomes a guided visualization (“目を閉じて…”) before feelings selection, Step5 captures emotions ahead of the reason text. Stage prompt prioritizes the “why” copy, enforces a 30 m focus radius, and requests photoreal scenery-only outputs.
  - Oct 08 2025: Added dedicated loop-GIF loading screens for scenery regeneration to keep the flow immersive while waiting on AI outputs.
- [x] Character flow (Step B): description moderation, Nanobanana character outputs, selection UI, progress bar kickoff, session lock.
  - Oct 08 2025: Integrated the matching loop-GIF loading screen while Emokai options generate.
  - Oct 08 2025: Added character naming during the generation step so the chosen name is stored in the record and send-off flow.
- [x] Parallel jobs (Step C1–C3): TripoAPI model generation (timeouts, storage), Nanobanana composite, OpenAI narrative with sanitization and status updates.
  - Oct 05 2025: Added automatic USDZ conversion via Tripo "convert_model" tasks when native output missing; emits debug logs for format selection on preview builds.
  - Oct 08 2025: Reused the creation loop-GIF screen during the combined 3D/Composite/Story jobs to surface progress while assets build.
- [x] Result screens (Step D): narrative view, composite display, AR entry gating, license notice, unload cancellation handling.
  - Oct 08 2025: Refined post-AR flow — Step14 now swaps from summon-only to a release confirmation, and Step15 sends the user back to the gallery with a single send-off action.
- [x] AR & 3D viewer (Step E): WebAR implementation, permission prompts, plane detection guidance, capture/save per OS, fallback viewer.
  - Oct 08 2025: Simplified the AR launcher/session UI — centered header logo, trimmed device info, and aligned fallback navigation with the send-off flow.
- [x] Persistence & sharing (Step F): daily limits, asset/metadata persistence, expiring share URLs, share sheet, OGP metadata.
- [x] Gallery (Step G): paginated public grid, detail view with AR/share options, license display, infinite scroll.
  - Oct 09 2025: Started gallery persistence uplift — Supabase schema added for `creations`, per-asset storage records, reviewer roles, and secure bucket separation to support Unity runtime access with stable URLs.
  - Oct 09 2025: Step15 send-off now posts to `/api/gallery/submissions`, capturing stage/character imagery, composite, emotion levels, geo metadata, and model links while clearing session storage once submission succeeds.
  - Oct 09 2025: Added reviewer API + `/admin/gallery` dashboard (token-gated) with status filters so moderators can inspect assets, annotate notes, and publish/reject entries via signed URLs.
  - Oct 09 2025: Exposed public gallery endpoints (`/api/gallery/public`, `/api/gallery/public/[slug]`) returning published entries for the main gallery and Unity feed.
  - Oct 10 2025: Gallery grid now consumes the public API with "load more" pagination, inline loading/error states, and detail pages surface emotion telemetry plus AR launches via signed model URLs stored in session.
- [x] Error & retry framework: localized messaging, retries, partial success handling, cancellation notices, accessible alerts.
- [x] Data lifecycle jobs: temp cleanup after 30 min, 24h session purge, 7-day deletion, Supabase backup integration.
- [x] Analytics & monitoring: GA4 events, completion/drop-off metrics, error logging schema.
- [ ] Testing & QA: unit/integration coverage, mocked external APIs, AR/device compatibility, accessibility, localization validation.
  - Progress 2025-10-01: Added unit tests for lib modules (device detection, moderation flows, generation jobs, share URL, env loader). All unit suites pass (`pnpm test`), lint clean. Coverage report generated; next focus is increasing `src/lib/*` coverage toward 85% and wiring Playwright against a running preview.
  - Oct 10 2025: Added component tests for the public gallery grid to validate pagination success/failure branches.
- [ ] Deployment & ops: backend functions/background workers, secrets management, CI/CD, performance monitoring.
  - Add GitHub Actions workflow for Vercel preview deploy + Playwright E2E (`.github/workflows/preview-e2e.yml`). Requires `VERCEL_TOKEN`, `VERCEL_ORG_ID`, `VERCEL_PROJECT_ID` secrets set in repo. E2E uses `PLAYWRIGHT_BASE_URL` from the deployed preview URL and runs with `VERCEL_ENV=preview`.
